<!-- File: frontend/chat.html -->
<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Embed Chatbot – SSE Test UI</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body{font:14px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,AppleGothic;}
        .wrap{max-width:720px;margin:40px auto;padding:16px;}
        .row{display:flex;gap:8px;align-items:center;margin-bottom:10px;}
        #chat{white-space:pre-wrap;border:1px solid #ddd;border-radius:8px;min-height:160px;padding:12px;overflow:auto;}
        input,button{padding:8px 10px}
        .tag{border:1px solid #ccc;border-radius:999px;padding:2px 8px}
    </style>
</head>
<body>
<div class="wrap">
    <h1>Embed Chatbot – Demo</h1>

    <div class="row">
        <label>API</label>
        <input id="api" size="36" value="http://localhost:9000" />
        <span class="tag" id="status">idle</span>
        <span class="tag" id="usage">latency – · tokens –</span>
    </div>

    <div class="row">
        <input id="msg" size="50" placeholder="메시지를 입력하세요…" value="hello sse" />
        <button id="send">보내기</button>
    </div>

    <div id="chat"></div>
</div>

<script>
    (() => {
        const API_INPUT = document.getElementById('api');
        const STATUS = document.getElementById('status');
        const USAGE = document.getElementById('usage');
        const CHAT  = document.getElementById('chat');
        const MSG   = document.getElementById('msg');
        const SEND  = document.getElementById('send');

        const BOT = 'sample-bot';
        let es, tries = 0, lastBeat = Date.now(), beatTimer, sending = false;

        function setStatus(s){ STATUS.textContent = s; }
        function setUsage(u){ USAGE.textContent = `latency ${u.latencyMs}ms · tokens ${u.completionTokens}`; }
        function append(t){ CHAT.textContent += t; CHAT.scrollTop = CHAT.scrollHeight; }

        function startHeartbeatWatchdog(){
            stopHeartbeatWatchdog();
            beatTimer = setInterval(() => {
                if (Date.now() - lastBeat > 20000) { es?.close?.(); onError(); }
            }, 5000);
        }
        function stopHeartbeatWatchdog(){ if (beatTimer) { clearInterval(beatTimer); beatTimer = null; } }

        function onError(){
            setStatus('error');
            sending = false;
            stopHeartbeatWatchdog();
            retry(MSG.value.trim());
        }

        function retry(message){
            tries++;
            const delay = Math.min(30000, 1000 * Math.pow(2, Math.min(tries, 5)));
            setStatus(`reconnecting in ${delay/1000}s…`);
            setTimeout(() => connect(message), delay);
        }

        function connect(message){
            const API = API_INPUT.value.trim();
            const sid = (localStorage.getItem('chat_sid') || crypto.randomUUID());
            localStorage.setItem('chat_sid', sid);
            const url = `${API}/v1/chat/stream?botId=${encodeURIComponent(BOT)}&message=${encodeURIComponent(message)}&sessionId=${encodeURIComponent(sid)}`;

            try { es?.close?.(); } catch {}
            es = new EventSource(url);
            sending = true; tries = 0; lastBeat = Date.now();
            setStatus('connecting…'); startHeartbeatWatchdog();

            es.addEventListener('open', () => setStatus('open'));
            es.addEventListener('token', (e) => { append(e.data); lastBeat = Date.now(); });
            es.addEventListener('usage', (e) => { try { setUsage(JSON.parse(e.data)); } catch {} lastBeat = Date.now(); });
            es.addEventListener('keepalive', () => { lastBeat = Date.now(); });
            es.addEventListener('done', () => { setStatus('done'); sending = false; stopHeartbeatWatchdog(); es.close(); });
            es.onerror = onError;
        }

        SEND.addEventListener('click', () => {
            if (sending) return;
            const m = MSG.value.trim();
            if (!m) return;
            CHAT.textContent = '';
            setUsage({ latencyMs: '–', completionTokens: '–' });
            connect(m);
        });
    })();
</script>
</body>
</html>
